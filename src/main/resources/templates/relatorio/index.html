<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/../fragments/head :: head('Relat√≥rios de Envios de Equipamentos')}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div th:replace="~{/../fragments/head :: header}"></div>
<br><br><br>

<div class="container-fluid ps-3 pe-3">

    <div class="row g-2 mb-3">
        <div class="col-auto">
            <input type="date" id="dataInicio" class="form-control" placeholder="Data In√≠cio">
        </div>
        <div class="col-auto">
            <input type="date" id="dataFim" class="form-control" placeholder="Data Fim">
        </div>
        <div class="col-sm-4">
            <input type="text" id="emailDestinatario" class="form-control" placeholder="E-mails separados por ;">
        </div>
    </div>

    <div class="d-flex mb-3">
        <button id="exportarExcel" class="btn btn-success">üíæ Salvar Excel</button>
        <button id="enviarExcel" class="btn btn-primary me-2">üìß Enviar por E-mail</button>
    </div>

    <!-- Tabela -->
    <div class="table-scroll">
        <div class="custom-table-wrapper table-responsive table-sm">
            <table id="tabelaEnvios" class="table table-hover table-bordered align-middle text-center">
                <thead>
                <tr>
                    <th>ID Envio</th>
                    <th>N¬∫ S√©rie Equip.</th>
                    <th>Placa</th>
                    <th>Tipo</th>
                    <th>Modelo</th>
                    <th>Origem</th>
                    <th>Loja Destino (ID)</th>
                    <th>Motivo</th>
                    <th>Data Envio</th>
                    <th>Usu√°rio Envio</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="envioAtual : ${enviosList}">
                    <td th:text="${envioAtual.pk_envio}"></td>
                    <td th:text="${envioAtual.equipamento.pk_num_serie}"></td>
                    <td th:text="${envioAtual.equipamento.placa}"></td>
                    <td th:text="${envioAtual.equipamento.tipo}"></td>
                    <td th:text="${envioAtual.equipamento.modelo}"></td>
                    <td th:text="${envioAtual.origem}"></td>
                    <td th:text="${envioAtual.lojaDestino.pk_loja}"></td>
                    <td th:text="${envioAtual.motivo}"></td>
                    <td th:text="${envioAtual.data_envio}"></td>
                    <td th:text="${envioAtual.usuario_envio}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<div th:replace="~{/../fragments/footer :: footer}"></div>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // Fun√ß√£o para gerar Excel filtrado
    function gerarExcel() {
        const inicio = document.getElementById("dataInicio").value;
        const fim = document.getElementById("dataFim").value;

        // Pega os headers da tabela
        const headers = Array.from(document.querySelectorAll("#tabelaEnvios thead th"))
            .map(th => th.innerText);

        // Pega os dados filtrados
        const linhas = Array.from(document.querySelectorAll("#tabelaEnvios tbody tr"))
            .filter(row => filtrarPorData(row, inicio, fim))
            .map(row => Array.from(row.cells).map(cell => cell.innerText.toString()));

        // Junta headers + linhas
        const dados = [headers, ...linhas];

        const ws = XLSX.utils.aoa_to_sheet(dados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio");
        return wb;
    }

    function filtrarPorData(row, inicio, fim) {
        const dataCol = row.cells[8].innerText.trim(); // coluna Data Envio
        if (!dataCol) return false;

        const data = new Date(dataCol); // yyyy-MM-dd funciona direto
        if (!data.getTime()) return false; // verifica se √© data v√°lida

        const inicioDate = inicio ? new Date(inicio + 'T00:00:00') : null;
        const fimDate = fim ? new Date(fim + 'T23:59:59') : null;

        if (inicioDate && data < inicioDate) return false;
        if (fimDate && data > fimDate) return false;

        return true;
    }

        // Bot√£o: salvar Excel localmente
        document.getElementById("exportarExcel").addEventListener("click", () => {
            const wb = gerarExcel();
            XLSX.writeFile(wb, "relatorio.xlsx");
        });

    // Bot√£o: enviar Excel por e-mail
    document.getElementById("enviarExcel").addEventListener("click", async () => {
        // ... (o c√≥digo para gerar o blob e o formData continua o mesmo)
        const wb = gerarExcel();
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const formData = new FormData();
        formData.append("file", blob, "relatorio.xlsx");
        const emailsInput = document.getElementById("emailDestinatario").value;
        // ... (a valida√ß√£o de e-mail continua a mesma)
        formData.append("destinatarios", emailsInput);

        try {
            // --- IN√çCIO DAS MUDAN√áAS ---

            // 1. Pega o token e o nome do cabe√ßalho das meta tags que voc√™ adicionou no HTML
            const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

            const response = await fetch('/relatorio/enviarExcel', {
                method: 'POST',
                headers: {
                    // 2. Adiciona o token CSRF no cabe√ßalho da requisi√ß√£o
                    [header]: token
                },
                body: formData
            });

            // --- FIM DAS MUDAN√áAS ---

            const result = await response.text();
            alert(result);
        } catch (err) {
            alert("Erro ao enviar e-mail: " + err);
        }
    });
});
</script>

<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/../fragments/head :: head('RelatÃ³rios de Envios de Equipamentos')}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div th:replace="~{/../fragments/head :: header}"></div>
<br><br><br>

<div class="container-fluid ps-3 pe-3">

    <div class="row g-2 mb-3">
        <div class="col-auto">
            <input type="date" id="dataInicio" class="form-control" placeholder="Data InÃ­cio">
        </div>
        <div class="col-auto">
            <input type="date" id="dataFim" class="form-control" placeholder="Data Fim">
        </div>
        <div class="col-sm-4">
            <input type="text" id="emailDestinatario" class="form-control" placeholder="E-mails separados por ;">
        </div>
    </div>

    <div class="d-flex mb-3">
        <button id="exportarExcel" class="btn btn-success">ðŸ’¾ Salvar Excel</button>
        <button id="enviarExcel" class="btn btn-primary me-2">ðŸ“§ Enviar por E-mail</button>
    </div>

    <!-- Tabelas ocultas, mas ainda legÃ­veis pelo XLSX -->
    <div style="display: none;">
        <!-- Tabela de Envios -->
        <table id="tabelaEnvios">
            <thead>
            <tr>
                <th>ID Envio</th>
                <th>NÂº SÃ©rie Equip.</th>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Modelo</th>
                <th>Origem</th>
                <th>Loja Destino (ID)</th>
                <th>Motivo</th>
                <th>Data Envio</th>
                <th>UsuÃ¡rio Envio</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="envioAtual : ${enviosList}">
                <td th:text="${envioAtual.pk_envio}"></td>
                <td th:text="${envioAtual.equipamento.pk_num_serie}"></td>
                <td th:text="${envioAtual.equipamento.placa}"></td>
                <td th:text="${envioAtual.equipamento.tipo}"></td>
                <td th:text="${envioAtual.equipamento.modelo}"></td>
                <td th:text="${envioAtual.lojaOrigem?.pk_loja}"></td>
                <td th:text="${envioAtual.lojaDestino.pk_loja}"></td>
                <td th:text="${envioAtual.motivo}"></td>
                <td th:text="${envioAtual.data_envio}"></td>
                <td th:text="${envioAtual.usuario_envio}"></td>
            </tr>
            </tbody>
        </table>

        <!-- Tabela de Descartes -->
        <table id="tabelaDescartes">
            <thead>
            <tr>
                <th>NÂº sÃ©rie</th>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Modelo</th>
                <th>Motivo</th>
                <th>Ãšltima localizaÃ§Ã£o</th>
                <th>Data Descarte</th>
                <th>UsuÃ¡rio</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="descarte : ${descartesList}">
                <td th:text="${descarte.equipamento.pk_num_serie}"></td>
                <td th:text="${descarte.placa}"></td>
                <td th:text="${descarte.tipo}"></td>
                <td th:text="${descarte.modelo}"></td>
                <td th:text="${descarte.motivo}"></td>
                <td th:text="${descarte.ultima_localizacao}"></td>
                <td th:text="${descarte.data}"></td>
                <td th:text="${descarte.usuario}"></td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<div th:replace="~{/../fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    function gerarExcel() {
        const inicio = document.getElementById("dataInicio").value;
        const fim = document.getElementById("dataFim").value;

        const tabelas = [
            { id: "tabelaEnvios", colunaData: 8, nomeSheet: "Envios" },
            { id: "tabelaDescartes", colunaData: 6, nomeSheet: "Descartes" }
        ];

        const wb = XLSX.utils.book_new();

        tabelas.forEach(tabela => {
            const elem = document.getElementById(tabela.id);
            if (!elem) return;

            const headers = Array.from(elem.querySelectorAll("thead th")).map(th => th.innerText);

            const linhas = Array.from(elem.querySelectorAll("tbody tr"))
                .filter(row => {
                    const dataCol = row.cells[tabela.colunaData].innerText.trim();
                    if (!dataCol) return false;

                    const data = new Date(dataCol);
                    if (!data.getTime()) return false;

                    const inicioDate = inicio ? new Date(inicio + 'T00:00:00') : null;
                    const fimDate = fim ? new Date(fim + 'T23:59:59') : null;

                    if (inicioDate && data < inicioDate) return false;
                    if (fimDate && data > fimDate) return false;

                    return true;
                })
                .map(row => Array.from(row.cells).map(cell => cell.innerText));

            const dados = [headers, ...linhas];
            const ws = XLSX.utils.aoa_to_sheet(dados);
            XLSX.utils.book_append_sheet(wb, ws, tabela.nomeSheet);
        });

        return wb;
    }

    document.getElementById("exportarExcel").addEventListener("click", () => {
        const wb = gerarExcel();
        XLSX.writeFile(wb, "Relatorio-Envio-Descarte-Equipamentos.xlsx");
    });

    document.getElementById("enviarExcel").addEventListener("click", async () => {
        const wb = gerarExcel();
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: "application/octet-stream" });
        const formData = new FormData();
        formData.append("file", blob, "Relatorio-Envio-Descarte-Equipamentos.xlsx");
        formData.append("destinatarios", document.getElementById("emailDestinatario").value);

        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        try {
            const response = await fetch('/planilha/enviarExcel', {
                method: 'POST',
                headers: { [header]: token },
                body: formData
            });
            alert(await response.text());
        } catch (err) {
            alert("Erro ao enviar e-mail: " + err);
        }
    });

});
</script>
